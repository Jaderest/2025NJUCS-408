# 第五章 传输层

## 目录
- [第五章 传输层](#第五章-传输层)
  - [目录](#目录)
- [5.1 传输层提供的服务](#51-传输层提供的服务)
  - [5.1.1 传输层的功能](#511-传输层的功能)
    - [应用进程之间的逻辑通信](#应用进程之间的逻辑通信)
    - [复用和分用](#复用和分用)
    - [差错检测](#差错检测)
    - [提供面向连接和无连接的传输协议](#提供面向连接和无连接的传输协议)
  - [5.1.2 传输层的寻址与端口](#512-传输层的寻址与端口)
    - [端口的作用](#端口的作用)
    - [端口号](#端口号)
    - [套接字](#套接字)
  - [考点\&易错点](#考点易错点)
- [5.2 UDP](#52-udp)
  - [5.2.1 UDP数据报](#521-udp数据报)
    - [UDP概述](#udp概述)
    - [UDP首部格式](#udp首部格式)
  - [5.2.2 UDP校验](#522-udp校验)

# 5.1 传输层提供的服务

## 5.1.1 传输层的功能

- 为运行在不同主机上的**进程**之间提供**逻辑通信**
  - 属于面向通信部分的最高层
  - 也是面向用户功能的最底层
  - 为应用程序提供可靠的服务
- 补充
  - 数据链路层提供**链路上相邻节点**之间的逻辑通信
  - 网络层提供**主机**之间的逻辑通信

### 应用进程之间的逻辑通信

- 也称**端到端**的逻辑通信，从传输层来看，通信的真正端点是主机中的进程

### 复用和分用

- 复用：发送方**不同应用进程**都可以使用**同一个传输层协议**传送数据
- 分用：接收方传输层在剥去报文首部后，能把数据正确交付到目的应用进程
- 补充
  - 网络层也有复用分用
  - 网络层复用：发送方不同协议的数据都可被封装成IP数据报发送出去
  - 分用：接收方网络层剥去首部后将数据交付给相应协议

### 差错检测

- 对**首部和数据部分**进行差错检测
  - TCP发现报文段出错，则要求发送方重发
  - UDP发现数据报出错，则直接丢弃

### 提供面向连接和无连接的传输协议

- 使应用程序看见的是两个传输层实体（进程）之间好像有一条端到端的逻辑通信信道
  - 采用TCP时，这种逻辑信道相当于一条全双工的可靠信道
  - 当传输层采用无连接UDP时，这种逻辑通信信道仍是一条不可靠信道

## 5.1.2 传输层的寻址与端口

### 端口的作用

- 标识主机中的应用进程 —— 传输层的服务访问点为”端口号“字段
- 软硬件端口
  - 软件端口，应用层各种协议进程与传输实体进行层间交互的一种地址 —— **传输层**使用
  - 硬件端口，不同硬件设备进行交互的接口

### 端口号

- 根据范围分类

  - 服务器端使用的端口号

    - 熟知端口号0~1023

      |  应用程序  | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
      | :--------: | ---- | ------ | ---- | ---- | ---- | ---- | ---- |
      | 熟知端口号 | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

      

    - 登记端口号1024~49151 —— 使用这类端口号需要在IANA登记

  - 客户端使用的端口号49152~65535

    - 仅在客户进程运行时才动态选择，也称**1**

### 套接字

- 套接字实际上是一个通信端点

  ​	`套接字(Socket) = (IP地址: 端口号)`

## 考点&易错点

- 背记

| 互联网应用   | TCP/IP应用层协议         | TCP/IP传输层协议 |
| ------------ | ------------------------ | ---------------- |
| 域名解析     | 域名系统（DNS）          | UDP              |
| 文件传送     | 简单文件传送协议（TFTP） | UDP              |
| 路由选择     | 路由信息协议（RIP）      | UDP              |
| IP地址分配   | 动态主机配置协议（DHCP） | UDP              |
| 网络管理     | 简单网络管理协议（SNMP） | UDP              |
| IP多播       | 网际组管理协议（IGMP）   | UDP              |
| 电子邮件     | 简单邮件传送协议（SMTP） | TCP              |
| 远程终端接入 | 远程终端协议（TELNET）   | TCP              |
| 万维网       | 超文本传送协议（HTTP）   | TCP              |
| 文件传送     | 文件传送协议（FTP）      | TCP              |

- IP数据报和UDP数据报的区别
  - IP数据报在网络层须**经过路由器**的存储转发
  - UDP封装成IP数据报后，UDP数据报信息**对路由器不可见**

# 5.2 UDP

## 5.2.1 UDP数据报

### UDP概述

- UDP仅在IP层的数据报服务之上增加了复用、分用和差错检测的功能
- UDP**面向报文**：对于应用层交下来的报文，添加首部后直接向下交付给IP层，一次发送一个报文
  - 易错：若报文太长，UDP交给IP层后可能导致分片，IP层交给数据链路层（MTU较小的话）也会分片
  - **UDP首部字段中长度和校验和都可能会改变**

### UDP首部格式

- 首部8B，4个字段
  - 源端口 —— 不需要时可全0
  - 目的端口
  - 长度
  - 校验和 —— 不想计算时直接全0

## 5.2.2 UDP校验

- 12B伪首部
- 校验包括首部&数据部分 —— UDP被分片时会改变校验和

- 校验和计算方法 —— **小心最后计算完需要取反码**
