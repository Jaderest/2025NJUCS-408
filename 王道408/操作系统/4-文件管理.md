# 第四章 文件管理

## 目录
- [第四章 文件管理](#第四章-文件管理)
  - [目录](#目录)
  - [4.1 文件系统基础](#41-文件系统基础)
    - [4.1.1 文件的基本概念](#411-文件的基本概念)
      - [文件的定义](#文件的定义)
      - [文件的属性](#文件的属性)
      - [文件的分类](#文件的分类)
    - [4.1.2 文件控制块和索引节点](#412-文件控制块和索引节点)
      - [文件控制块](#文件控制块)
      - [索引节点](#索引节点)
    - [4.1.3 文件的操作](#413-文件的操作)
      - [文件基本操作（考：详细过程）](#文件基本操作考详细过程)
      - [文件的打开与关闭](#文件的打开与关闭)
    - [4.1.4 文件逻辑结构](#414-文件逻辑结构)
      - [无结构文件](#无结构文件)
      - [有结构文件](#有结构文件)
    - [4.1.5 文件的物理结构](#415-文件的物理结构)
      - [连续分配](#连续分配)
      - [链接分配](#链接分配)
      - [索引分配](#索引分配)
    - [4.1.6 文件保护](#416-文件保护)
      - [访问类型](#访问类型)
      - [访问控制](#访问控制)
      - [口令和密码](#口令和密码)
      - [多级目录结构](#多级目录结构)

## 4.1 文件系统基础
区分文件的逻辑结构&物理结构

### 4.1.1 文件的基本概念
**文件**：硬盘为载体的存储在计算机上的信息集合
- 系统运行时
  - 进程是资源调度和分配的基本单位
  - 文件是用户输入和输出的基本单位
- 文件系统：实现对文件的维护管理

#### 文件的定义
- 对文件的理解
  - 文件必定包括存储空间中的数据
  - OS管理大量的数据 -> 文件必定包含分类和索引信息
  - 不同用户对数据访问权限不同 -> 文件必定包含访问权限的信息
- 文件系统是OS的重要组成部分
  - 用户关心：如何命名、分类、查找文件，如何保证数据安全性，对哪些文件可以进行哪些操作
  - 文件系统：提供二级存储相关资源的抽象，让用户能不了解文件的各种属性、文件存储介质特征、存储介质上具体位置等情况下，仍能方便快捷使用文件。
  - 用户使用文件系统建立文件，用于应用程序的输入、输出，对资源进行管理
- 文件的结构（自底向上定义）
  - **数据项**：文件系统中最低级的数据组织形式
    - **基本数据项**：用于描述一个对象某个属性的一个值，数据中的**最小逻辑单位**
    - **组合数据项**：多个基本数据项组成
  - **记录**：一组相关数据项的集合，描述一个对象在某方面的属性
  - **文件**：**创建者**定义的，**具有文件名**的一组相关元素的集合
    - 有结构文件，文件由若干个相似的记录组成，如一个班的学生记录
    - 无结构文件，字符流，比如一个二进制文件或字符文件
- 虽然给出结构化的表述，但是文件并无严格定义
  - OS中，通常将程序和数据组织成文件，文件可以是数字、字符或二进制代码，基本访问单元可以是字节或记录
  - 文件可以
    - 长期存储在硬盘中
    - 允许可控制进程间共享访问
    - 能被组织成复杂的结构

#### 文件的属性
除了文件数据，OS还会保存与文件相关的信息，如所有者、创建时间等，这些附加信息称为**文件属性**或**文件元数据**

OS通过文件控制块维护文件元数据

通常还包括如下属性：
1. 名称。文件名称唯一，以容易读取的形式保存
2. 类型。被支持不同类型的文件系统使用
3. 创建者。文件创建者的ID
4. 所有者。文件当前所有者的ID
5. 位置。指向设备和设备上文件的指针
6. 大小。文件当前大小（字节、字或块表示），也可包含文件允许的最大值
7. 保护。对文件进行保护的访问控制信息
8. 创建信息、最后一次修改时间、最后一次存取时间。文件创建、上次修改和上次访问的相关信息，用于*保护和跟踪文件的使用*

#### 文件的分类
几种常见的文件分类方式：
1. 按性质和用途分类：系统文件、用户文件、库文件
2. 文件中数据的形式分类：源文件、目标文件、可执行文件
3. 存取控制属性分类：可执行文件、只读文件、读/写文件
4. 组织形式和处理方式分类：普通文件、目录文件、特殊文件


### 4.1.2 文件控制块和索引节点
与进程管理一样，便于文件管理引入**文件控制块（File Control Block, FCB）**的数据结构

#### 文件控制块
- 文件控制块是用来存放控制文件需要的各种信息的数据结构 -> 实现**按名存储**
- 文件与FCB一一对应 -> FCB有序集合被称为**文件目录**
  - 一个FCB就是一个**一个文件目录项**
- 一个文件目录也被视为一个文件，称为**目录文件**
- 每创建一个新文件，系统就要为其建立一个FCB，如下是一个典型的FCB  
  |文件名|类型|文件权限（读，写）|文件大小|文件数据块指针|
- FCB主要包含以下信息：
  - 基本信息：如文件名、物理位置、逻辑结构、物理结构
  - 存取控制信息：包括文件主的存取权限、核准用户的存取权限及一般用户的存取权限
  - 使用信息：如建立时间、上次修改时间等

#### 索引节点
- 检索目录时，除文件名外的描述信息不会用到也不会调入内存 -> UNIX采用文件名和文件描述信息分离的方式：
  - **文件描述信息** 单独形成一个称为**索引节点（inode）**的数据结构，简称**i节点**（inode）
  - 文件目录中每个目录项仅由 *文件名* 和 相应 *索引节点号*（或*索引节点指针*） 组成
- 磁盘索引节点（存放在磁盘上的索引节点），包括以下内容
  - *文件主标识符*，拥有该文件的个人/组织的标识符
  - *文件类型*，如普通文件、目录文件或特别文件
  - *文件存取权限*，各用户对该文件的存取权限
  - *文件物理地址*， 每个索引节点含13各地址项，iaddr(0)~iaddr(12)，直接/间接给出数据文件所在盘块编号
  - *文件长度*，以字节为单位的文件长度
  - *文件链接计数*，指向该文件的文件名的指针计数
  - *文件存取时间*，包括创建时间、上次修改时间和上次访问时间
- 内存索引节点，存放在内存中的索引节点，文件被打开时，将磁盘索引节点复制到内存的索引节点中便于以后使用。添加了以下内容
  - *索引节点号*
  - *状态*，是否上锁or被修改
  - *访问计数*
  - *逻辑设备号*
  - *链接指针*
- FCB或索引节点相当于图书馆中图书的索书号

### 4.1.3 文件的操作

#### 文件基本操作（考：详细过程）
- 文件属于**抽象数据类型**，为正确定义文件，需要考虑对文件的操作
- OS提供一系列系统调用，实现文件的创建、删除、读写、打开、关闭等操作
  - 创建文件
    - 为新文件分配外存空间
    - 目录中创建一个目录项
  - 删除文件
    - 根据文件名查找目录，删除对应目录项和FCB，回收文件占用存储空间（磁盘+内存缓冲区）
  - 读文件
    - 查找目录，找到目录项，得到文件在外存中地址；目录项中还有一个指针用于文件读操作
  - 写文件
    - 查找目录，找到目录项，得到写指针对文件写操作；每发生写操作便更新写指针

#### 文件的打开与关闭
考：打开/关闭的过程，多进程同时打开文件的分析，文件名和文件描述符

为了避免多次重复检索目录，用户首次对文件发送操作请求时，使用*系统调用open*打开文件，系统维护一个包含**所有**打开文件信息的表，称为**打开文件表**（Open File Table, OFT）
- **打开**
  - 系统检索到执行文件目录项
  - 将目录项从外存复制到内存中打开文件表的一个表目中
  - 将打开文件表该表目的*索引号*（**文件描述符**）返回给用户
  - 用户再次对该文件发送操作请求时，直接使用该文件描述符找到文件信息，从而节省大量检索开销
- **关闭**
  - 用户对文件操作完成后，使用*系统调用close*关闭文件
  - 系统将打开文件表中该文件的表目删除
- **多进程同时打开文件**
  - 采用两级表：
    - 整个系统表
      - 包含进程无关信息，文件在磁盘上位置，访问日期，文件大小等
    - 每个进程表
      - 包含进程对文件使用信息，如文件当前读写指针，文件访问权限及指向系统表中适当条目的指针
  - 一旦有进程打开一个文件，系统表就包含该文件的条目；另一个进程执行调用open时，只是进程打开文件表中增加一个条目，并指向系统表相应条目
  - 系统打开文件表为每个文件关联一个**打开计数器**（Open Count）
  - 进程调用close，删除它的打开文件表中条目，同时系统表该文件的打开计数器减1
    - 打开计数器为0时，文件不再被使用，并且可从系统表中删除该条目
  - 内存中文件结构如下
    ![内存中文件系统的结构](./4-pic/4-1内存中文件的系统结构.jpg)
    - 数据块、文件控制块存储在辅助存储中
    - 进程表&系统表存储在内核内存中
    - 索引号存储在用户空间中
- 文件名&文件描述符
  - 完成FCB在磁盘上的定位后，**系统不再使用文件名**，而是使用文件描述符来标识文件
  - UNIX称之为**文件描述符**
  - Windows称之为**文件句柄**
- 每个打开文件有如下关联信息
  - 文件指针
  - 文件打开计数
  - 文件磁盘位置
  - 访问权限

### 4.1.4 文件逻辑结构
逻辑结构：从用户角度出发看到的文件的组织形式  
物理结构：文件存储在外存上的存储组织形式，用户看不见的

逻辑结构分类如下：
#### 无结构文件
- 最简单的文件组织形式，字符流构成，也称**流式文件**
- 长度以字节为单位
- 读写指针指出下一个要访问的字节
- 系统中大量源程序、可执行文件、库函数等采用的都是无结构文件
- 没有结构，对无结构文件记录的访问只能通过**穷举搜索**的方式 -> 对很多应用不适用

#### 有结构文件
- 一个以上记录构成的文件，也称**记录式文件**
  - 定长记录
    - 所有记录长度都相同，各数据项都在记录中相同位置，具有相同长度
    - 检索记录的速度快，方便文件处理、数据处理
  - 变长记录
    - 文件中各记录长度不一定相同
    - 可能是记录中数据项数量不同/数据项本身长度不定
    - 顺序查找，速度慢

有结构文件按记录的组织形式分类如下
1. 顺序文件
   - 文件一个接一个顺序排列，记录可以是变长也可以是定长
   - 顺序文件中记录的排列有两种结构
     - 串结构：顺序与关键字无关，按存入先后时间排列，必须从头开始顺序依次查找
     - 顺序结构：按关键字顺序排列，对定长记录的顺序文件，可二分查找
   - 特点
     - 读写效率最高
     - 对于顺序存储设备（如磁带）是最有效的存储方式
     - 但高频率单个记录的查找修改删除，顺序文件性能较差
2. 索引文件
   - 变长记录的顺序文件只能顺序查找，效率低 -> 建立索引表，主文件每个记录设置一个索引表项
   - 索引表项包含
     - 指向记录的指针
     - 记录的长度
   - 索引表按关键字排序（它本身就是一个定长记录的顺序文件）
   - 变长记录顺序文件的**顺序检索** -> 定长记录索引文件的**随机检索**，加快了记录的检索速度
   - 索引文件需配置索引表，每个记录要一个索引项，增加了存储开销
3. 索引顺序文件
   - 顺序文件和索引文件的结合
   - 变长记录顺序文件分为若干组，为文件建立索引表，**每组第一个**记录建立一个索引项，包含该**记录的关键字**和**指向该记录的指针**
   - 同组内关键字可以无须（本来就是从变长记录顺序文件中来的）
   - **但是组与组间关键字必须有序**
   - 每组第一个记录的键及逻辑地址放入索引表，索引表按关键字顺序排列
   - 一级索引**检索**时：查找索引表（找该记录的组），然后在组内顺序查找
     - 平均共需$\sqrt{n} = \sqrt{n}/2 + \sqrt{n}/2$次查找
4. 直接文件/散列文件（Hash File）
   - 很高的存取速度
   - 容易引起冲突，不同关键字散列函数值可能相同

实际上有结构文件逻辑上的组织是为查找数据服务的（顺序查找、索引查找、索引顺序查找、hash查找）


### 4.1.5 文件的物理结构
物理结构：研究文件的实现，在物理存储设备上如何分布和组织？有如下两种回答
- 文件的分配方式：对磁盘非空闲块的管理
  - 对应文件的物理结构，如何为文件分配磁盘块（**注意区分文件的逻辑结构**）
    - 连续分配 （类似于线性表）
    - 链接分配 （类似于顺序表）
    - 索引分配 （类似于链表）
- 文件存储空间管理：对磁盘空闲块的管理
- 磁盘存储单元也被分为一个个块，称为**磁盘块**，大小与内存页面大小相同

#### 连续分配
- 要求每个文件在磁盘上占有一组连续的块
- 磁盘地址定义了磁盘上的一个**线性排序**，使得进程访问磁盘时需要的寻道数和寻道时间最小
- 优点：
  - 支持顺序访问&直接访问
  - 顺序访问容易且速度块，文件所占用的块可能位于一条或几条相邻的磁道上，磁头移动距离最小
- 缺点：
  - 连续存储空间 -> 很多外部碎片
  - 必须事先知道文件长度，无法满足文件动态增长的需要
  - 为保持有序性，删除&插入记录时，需要对相邻记录进行物理上的移动，效率低

#### 链接分配
离散分配方式
- 优点：
  - 消除磁盘外部碎片，提高磁盘利用率
  - 方便动态为文件分配磁盘块，无须事先知道文件大小
  - 文件插入、删除和修改也非常方便

链接分配分为*隐式链接*和*显式链接*
1. 隐式链接（指针分配于磁盘块中）
   - 隐式链接：目录项含有文件的第一块的指针（盘块号）和最后一块的指针
   - 每个文件对应一个磁盘块的链表，磁盘块分布在磁盘的任何地方
     - 除文件的最后一个盘块外，每个磁盘块中含有下一个磁盘块的指针（对用户是透明的）
   - 缺点：
     - 只支持顺序访问，随机访问效率很低
     - 稳定性问题：任何一个指针出问题，都会导致文件数据的丢失
     - 指向下一个盘块的指针也要耗费一定的存储空间
   - 按**簇**分配
     - 几个盘块组成一个簇（Cluster），作为分配的基本单位
     - 可以大幅减少查找时间，减小指针所占用存储空间
     - 但是增加了内部碎片

2. 显式链接
   - 显示链接：用于链接文件各物理块的指针，显示存放于内存的一张链接表中
     - 这个链接表在整个文件系统中仅一张，称为**文件分配表（File Allocation Table, FAT）**
   - 每个表项中存放指向下一个盘块的指针
   - 文件目录中只需记录该文件起始块号，后续块号可查FAT得到
   - **FAT**一些细节
     - FAT表项中仅两项：盘块号，下一块的盘块号
     - 下一块盘块号 = **-1** 时，标记为文件的最后一块
     - 下一块盘块号 = **-2**（或别的更负的数）时，表示该磁盘块空闲 -> OS可以通过FAT对磁盘空闲空间进行管理
   - 优点：
     - 支持顺序访问，也支持直接访问，访问i块无需访问前i-1块
     - FAT在系统启动时就被读入内存，检索记录是在内存中进行
       - 显著提高检索速度
       - 减少了访问磁盘的次数
   - 缺点：
     - FAT需要占用一定的存储空间

#### 索引分配
1. 单级索引分配方式（考：索引分配的应用和分析）
   - 思想：为每个文件分配一个索引块（表），索引块中存放该文件所有盘块号
     - 没有必要将整个FAT调入内存，应将每个文件所有盘块号集中放在一起
     - 访问到某个文件时，将文件对应盘块号一起调入内存即可
   - 优点：
     - 支持直接访问
     - 不会产生外部碎片
   - 缺点：
     - 增加了额外的存储空间开销
   - 主要问题：
     - 每个文件**必须**有一个索引块
       - 当文件很小时，索引块利用率很低
       - 当文件很大时，如果连盘块号都需要占用若干索引块，虽然可以按需链接索引块，但是很低效
2. 多级索引分配方式
   - 文件太大而索引块太多时，应为这些索引块再建立一级索引，称为**主索引**
   - 将第一个索引块的盘块号、第二个索引块的盘块号……填入主索引表，形成了*二级索引分配方式*
   - 原理类似**多级页表**
   - e.g. 盘块大小4KB，每个盘块号4B，一个索引可放1024个盘块号，若采用两级索引，则支持的最大文件为1024 x 1024 x 4KB = 4GB （每个文件一个主索引，然后看几级索引能够表示多少盘块号）
   - 优点：
     - 极大加快对大型文件的查找速度
   - 缺点：
     - 访问一个盘块时，所需启动磁盘次数随索引级数增加而增多，即使数量众多的小文件也是如此
3. 混合索引分配方式（考：原理，混合索引相关计算，多级索引块访问效率分析）
   - 全面照顾到小型、中型和大型文件的存储需求，采用混合索引分配方式
   - 分配方式如下：
     - 小文件 -> 盘块地址直接放入FCB，**直接寻址**
     - 中型文件 -> 盘块地址放入索引块，**单级索引**
       - 先从FCB中找到该文件索引表，从中获得盘块地址，即**一次间址**
     - 大型/特大型文件 -> 两级或三级索引分配
   - 相关计算
     - 直接地址：
       - 索引节点设置10个直接地址项，i.addr(0)~i.addr(9)存放直接地址（即文件数据块盘块号）
       - 假如盘块大小4KB，文件不大于40KB，便可直接从inode读出该文件全部盘块号
     - 一次间接地址：
       - 索引节点中i.addr(10)提供*一次间接地址*，记录了文件一次间址块号，一次间址块就是索引块，记录了文件数据块的盘块号。一次间址块可以存放1024个盘块号。
       - 同时采用直接地址和一次间址，允许文件最大长度 1024 x 4KB + 10 x 4KB = 4096KB + 40KB = 4MB + 40KB
     - 多次间接地址：
       - 文件长度大于4MB + 40KB时，i.addr(11)提供*二次间接地址*，记录了二次间址块号，二次间址块也是索引块，记录了一次间址块的盘块号
       - 直接地址 + 一次间址 + 二次间址: 4GB + 4MB + 40KB
       - 三次的话就是 4TB + 4GB + 4MB + 40KB


### 4.1.6 文件保护
为了防止文件共享可能导致文件被破坏或未经核准的用户修改文件，文件系统需解决对文件的读、写、执行的许可问题。
需要设立文件保护机制：
- *口令保护*、*加密保护*：防止用户文件被他人存取或窃取
- *访问控制*等：控制用户对文件的访问方式

#### 访问类型
可以控制的访问类型有如下几种：
- 读
- 写
- 执行
- 添加：新信息添加到文件结尾
- 删除
- 列表清单：列出文件名和文件属性
- 此外还有高层功能：重命名、复制、编辑，这些可以通过以上底层系统调用提供，保护仅在低层提供
  - 例如复制可以通过一系列读实现，有读权限的用户则有了复制和打印权限

#### 访问控制
根据用户身份进行控制，每个文件添加一个访问控制表（Access-Control List, ACL）

使用精简的访问控制列表：
- 拥有者：创建文件的用户
- 组：一组需要共享文件且有类似访问的用户
- 其他：系统内所有其他用户

#### 口令和密码
- 口令：建立一个文件时提供一个口令，系统建立FCB时附上口令，告诉允许共享文件的用户，访问时需提供相应口令，空间时间开销不多，但是口令直接存在系统内部，不安全
- 密码：用户对文件加密，文件访问时需要使用密钥。保密性强，节省存储空间，但是编码译码需要花费时间

#### 多级目录结构
不仅需要保护单个文件，还需要保护子目录内文件，需要目录保护机制