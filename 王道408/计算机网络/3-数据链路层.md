# 第三章 数据链路层

## 目录
- [第三章 数据链路层](#第三章-数据链路层)
  - [目录](#目录)
  - [3.1 数据链路层的功能](#31-数据链路层的功能)
    - [3.1.1 数据链路层所处地位](#311-数据链路层所处地位)
      - [数据链路层理解](#数据链路层理解)
      - [基本概念](#基本概念)
    - [3.1.2 链路管理](#312-链路管理)
    - [3.1.3 封装成帧与透明传输](#313-封装成帧与透明传输)
      - [封装成帧](#封装成帧)
    - [3.1.4 流量控制](#314-流量控制)
    - [3.1.5 差错检测](#315-差错检测)
    - [考点易错点](#考点易错点)
  - [3.2 组帧](#32-组帧)
    - [3.2.1 字符计数法](#321-字符计数法)
    - [3.2.2 字节填充法](#322-字节填充法)
    - [3.2.3 零比特填充法（HDLC）](#323-零比特填充法hdlc)
    - [3.2.4 违规编码法](#324-违规编码法)
    - [总结](#总结)
    - [考点\&易错点](#考点易错点-1)
  - [3.3 差错控制](#33-差错控制)
    - [3.3.1 检错编码](#331-检错编码)
      - [奇偶校验码](#奇偶校验码)
      - [循环冗余码](#循环冗余码)
    - [3.3.2 纠错编码](#332-纠错编码)
      - [码距](#码距)
      - [海明码编码过程](#海明码编码过程)
    - [考点\&易错点](#考点易错点-2)

## 3.1 数据链路层的功能
- 三个基本问题
  - 封装成帧（组帧）
  - 透明传输
  - 差错检测
- 数据链路层使用的信道
  - 点对点信道，一对一的通信方式
    - PPP目前使用最广泛的点对点协议
  - 广播信道，这种信道上连接的主机很多，使用一对多广播通信方式
    - 有限局域网CSMA/CD协议
    - 无线局域网CSMA/CA协议

### 3.1.1 数据链路层所处地位

#### 数据链路层理解
考虑 主机H1 --局域网1-> 路由器R1 --广域网-> 路由器R2 --局域网2-> 主机H2
- 学习数据链路层时，通常只关系协议栈中 **水平方向的各数据链路层**
- 可通过如下链路 H1链路层 -> R1链路层 -> R2链路层 -> H2链路层
  - 这三段不同的数据链路可能采用**不同**的数据链路层协议

#### 基本概念
- 链路：指一个节点到**相邻节点**的一段物理线路
  - 两台计算机之间的通信路径往往经过许多段链路 —— 链路只是一条路径的组成部分
  - 链路 又称 物理链路
- 数据链路：
  - 在链路上传送数据时，除了需要链路本身，还需要**必要的通信协议**来控制这些数据的传输
  - 把实现这些协议的硬件和软件加到链路上，构成了数据链路
  - 数据链路 又称 逻辑链路
- 帧
  - 数据链路层对等实体之间进行逻辑通信的协议数据单元
    - 数据链路层把网络层下交的数据构成 帧 发送到链路
    - 接收到的 帧 中的数据取出交给网络层

### 3.1.2 链路管理
- 链路管理：数据链路层连接的 建立、维持和释放过程
  - 主要用于面向连接的服务
- 链路两端的节点要进行通信
  - 首先确认对方已处于就绪状态
  - 交换必要信息以对帧序号初始化，才能建立连接
  - 传输过程中要维持连接，而在传输完毕后释放该连接

### 3.1.3 封装成帧与透明传输

#### 封装成帧
- 指在一段数据前后分别添加首部和尾部，构成**帧**
  - 帧是数据链路层的传送单元
- **帧长**：数据部分长度加上首部尾部长度
- 帧定界：首部尾部有很多控制信息，重要作用是确定帧的界限
  - 接收方能从接收到的二进制比特流中区分帧的开始与结束
- HDLC协议中
  - 用标识位F（01111110）作为帧的开始和结束标志，帧格式如下：  
    |标志F|地址A（8位）|控制C（8位）|信息I（N位可变）|帧检验序列FCS（16位）|标志F|
- 为提高帧传输效率
  - 数据部分长度应尽可能大于首部和尾部长度
  - 但帧长增加，传输差错概率也提高，发送差错重传代价也越大
  - **最大传送单元**：每种链路层协议规定帧**数据部分**的最大长度
- **透明**：表示某个实际存在的事物看起来不存在一样
  - 举个例子，数据中恰好出现与帧界符相同的比特序列，则会错误地提前结束帧
- **透明传输**：不论什么比特组合的数据都能**按照原样无差错**地在数据链路上传输
  - 理解：数据看不见数据链路有什么妨碍传输的数据（这里例子就是标志F），所以数据链路层对于数据来说就是透明的

### 3.1.4 流量控制
- 流量控制：限制发送方发送速率，使之不超过接收方接收能力
  - 需要某种反馈机制
- OSI中，数据链路层具有流量控制功能
  - 控制相邻节点链路上的流量
- TCP/IP体系中，这个功能移到传输层
  - 控制从源到目的端之间的流量

### 3.1.5 差错检测
- 错误种类
  - 位错：CRC检验
  - 帧错：帧丢失、帧重复、帧失序

- OSI中
  - CRC校验
  - 给帧添加了帧编号、确认（发送的每个帧增加一个计时器）和重传机制

- 现代实现中
  - 通信质量良好的有线链路，数据链路层已不再使用确认和重传机制，仅需CRC校验丢弃错误帧
  - 重传交给高层协议完成

### 考点易错点
- 封装成帧也叫组帧
  
- OSI中，帧也有计时器，有超时重传机制

- 采取数据链路层服务种类
  - 信道可靠 —— 采用无确认服务
  - 实时性要求高 —— 无连接服务

## 3.2 组帧
- 发送方依照一定规则将网络层递交的分组封装成帧（也称组帧）
- 目的：
  - 以帧为单位传输，出错时可以只重传出错的帧，而不必重发全部数据
- 主要解决
  - 帧定界
  - 帧同步
  - 透明传输等问题

### 3.2.1 字符计数法
- 帧首部使用一个计数字段来记录该帧所含字节数（包括它自己所占1字节）
- 接收方
  - 读取帧首部字节计数值时，就知道后面跟随的字节数，从而确定帧结束位置
  - 自然也知道下一帧开始位置
- 缺点
  - 计数字段出错，则失去帧边界划分的依据，收发双方将失去同步

### 3.2.2 字节填充法
- 使用特定字节界定帧的开始与结束
  - 控制字符SOH放在帧最前面，表示帧的开始
  - 控制字符EOT表示帧的结束
  - 为使信息字符不被误判，特殊字符前填充一个转义字符ESC（使ASCII码中控制字符，是**一个字符**，而非ESC三个字符） —— 以此实现数据的透明传输
- **当帧中出现SOH或EOT或ESC的情况**
  - 发送方在每个EOT或SOH字符前再插入一个ESC字符，接收方自己删除这个插入的ESC字符
  - 结果得到原来的数据

### 3.2.3 零比特填充法（HDLC）
- 允许数据帧包含任意个数比特，使用特定比特串01111110标志一个帧的开始和结束（6个1）
- **发送方扫描整个数据字段**
  - **每**遇到连续的5个1，自动在其后插入一个0，即可保证数据段中不会出现标志（6个连续的1）
- 接收方
  - 每收到连续的5个1，自动删除后面紧跟的0
- 易于硬件实现，性能优于字节填充法

### 3.2.4 违规编码法
- 物理层比特编码时，常采用违规编码法
  - e.g. 曼彻斯特编码方法（是一种**冗余编码**方式） 1 -> 高-低电平；0 -> 低-高电平
    - 则高-高电平和低-低电平时违规的，可以用它们定界帧的起始和终止

### 总结
- 字符计数法，计数字段脆弱
- 字节填充法，实现复杂并且容易不兼容
- 较常采用的组帧方法是
  - 零比特填充法
  - 违规编码法

### 考点&易错点
- HDLC（零比特填充法），遇到连续的5个1就填充，并不是6个才填充并且隔开

## 3.3 差错控制
本节仅讨论比特差错，即1变0，0变1  
- 通常利用编码技术进行差错控制，主要是两类
  - 自动重传请求（ARQ，Automatic Repeat reQuest） —— **检错编码**
    - 检测到差错时就通知发送方重发，直到收到正确的为止
  - 前向纠错（FEC，Forward Error Correction） —— **纠错编码**
    - 接收方不但能检测到差错，还能确定错误位置并纠正

### 3.3.1 检错编码
- 检错编码：
  - 都采用**冗余编码**技术
  - 在有效数据（信息位）发送前，按某种关系附加一定的冗余位（校验位），构成一个符合某一规则的码字后发送
  - **有效数据变化 -> 冗余位也会变化**
  - 码字遵从不变的规则，接收方根据收到的码字是否符合原规则来判断是否出错

#### 奇偶校验码
- n-1位数据，1位检验位
  - 奇校验：使得所有1的个数为奇数
  - 偶校验：使得所有1的个数为偶数
- 只能检测奇数位出错情况，不知道哪些位出错，也不能发现偶数位出错情况

#### 循环冗余码
- CRC检错基数
- 基本思想
  - 收发双方约定生成一个多项式G(x)，称为生成多项式（要求最低位必须为1），k位位串 视为 阶数k-1 的多项式的系数序列
    - e.g. 1101 -> x^3 + x^2 + 1
  - 发送方基于待发送数据和G(x)，计算出冗余码，冗余码附加到数据后一起发送
  - 接收方收到数据和冗余码后，通过G(x)计算收到的数据和冗余码是否差错
- 实际计算：
  - 给定 **m**位数据，CRC产生**r**位冗余码（称为*帧检验序列* FCS）
  - 数据左移r位（低位补0） 模2除以 G(x)对应二进制串 得到余数 即为冗余码
  - 冗余码r位，前面的0不可省略
- 模2除法 结果上等于 逻辑异或运算
- 计算举例
  - M = 101001 (m=6); G(x) = 1101 (r=3)
  - M左移3位：101001000，模2除以G(x)
  - 得余数 R = 001，作为FCS附加到M后面
- CRC具有纠错功能，只是数据链路层仅使用它的检错功能

### 3.3.2 纠错编码
- 最常见：**海明码**
- 原理：
  - 有效信息位中加入几个检验位形成海明码
  - 海明码每个二进制位分配到几个奇偶校验组中
  - 某一位出错，相关检验位值就会发生变化 -> 可以发现错位，并且能确定位置

#### 码距
- 编码的检错和纠错能力都与该编码最小距离有关
- **码距**（也称海明距离）是指两个码字对应位取值不同的比特数量
  - 两个位串异或，1的个数即为码距
  - e.g. 0110 和 0011 异或为 0101，码距为2 （有点想起格雷码）
- **编码集的码距**：编码集中任意两个码字的码距的最小值
  -  e.g. {10011, 01011, 1110, 00001}，码距为2
- 根据**纠错理论**，编码方案的**检错能力**和**纠错能力**与**码距l**关系如下
  - 检错位数 d；纠错位数 c；码距 l
  - l = d + c + 1   (d >= c，能纠错必定能检错)
- 结论
  - 为了检测d位错误，码距至少为d+1 （当有效码字发生d位错误时不可能变成另一个有效码字）
    - 码距位1的编码方案无法检测任何错误
  - 为了纠正c位错误，码距至少2c+1 （有效码字发生c位错误时，它还是离原来码字最近，达到纠错目的）

#### 海明码编码过程
- 海明码具有1位纠错能力，以1010为例如下
1. 确定海明码位数
   - 信息位n位，检验位k位，k位检验位能表示2^k种状态，信息位和检验位共 n+k 种1位出错的办法，此外还需要1种表示信息正确的状态
   - 满足 2^k >= n + k + 1
   - 例如n=4，k=3，2^3 >= 4 + 3 + 1 成立
   - 信息位D4D3D2D1（1010），检验位P1P2P3
   - 则对应海明码为H7H6H5H4H3H2H1
2. 确定检验位分布
   - **规定检验位Pi在位号2^(i-1)处**，其余各位为信息位
   - P1在第1位，P2在第2位，P3在第4位，海明码分布如下  
      |H7|H6|H5|H4|H3|H2|H1|  
      |--|--|--|--|--|--|--|  
      |D4|D3|D2|P3|D1|P2|P1|  
3. 分组形成检验关系
   - 每个数据位使用多个检验位进行检验
   - 被检验数据位的海明位号 = 检验该数据各检验位海明位号之和
   - 分组检验关系如下
      |数据位|H1(P1) + H2(P2) + H4(P3)|
      |--|--|
      |D1(H3)|3 = 1 + 2|
      |D2(H5)|5 = 1 + 4|
      |D3(H6)|6 = 2 + 4|
      |D4(H7)|7 = 1 + 2 + 4|
4. 检验位取值
   - 检验位Pi值位为第i组（分组：该检验位检验的所有数据位）的所有位求异或
   - P1 = D1 ⊕ D2 ⊕ D4 = 0 ⊕ 1 ⊕ 1 = 0
   - P2 = D1 ⊕ D3 ⊕ D4 = 0 ⊕ 0 ⊕ 1 = 1
   - P3 = D2 ⊕ D3 ⊕ D4 = 1 ⊕ 0 ⊕ 1 = 0
   - 1010 -> 101*0*0*10*
5. 检验原理
   - 利用检验位和参与该检验位的信息位进行奇偶检验检查，得到k个检验方程
   - S1 = P1 ⊕ D1 ⊕ D2 ⊕ D4
   - S2 = P2 ⊕ D1 ⊕ D3 ⊕ D4
   - S3 = P3 ⊕ D2 ⊕ D3 ⊕ D4
   - S1、S2、S3的值为0，表示无错
   - S3S2S1 = 001，按二进制解读，第1位出错，表示H1位出错
   - 纠错：将H1位取反即可

### 考点&易错点
- 奇偶校验码时只能检测奇数位出错情况，不能发现偶数位出错情况
  - 注意 奇偶校验码会在数据末尾添加一位校验码
  - 校验码计算方式：
    - 奇校验：**使得**所有1的个数为奇数
    - 偶校验：**使得**所有1的个数为偶数

- CRC校验码
  - 计算的一些细节
    - 除式过程中 满r位就得出一位商
    - 每次除法得商位时不考虑大小关系，而是根据最高位来得商位是否为1
    - 然后二者取商时，直接作异或